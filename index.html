<!DOCTYPE HTML>
<html>
	<head>
		<title>SECRETARÍA DE FISCALIZACIÓN</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
		<link rel="stylesheet" href="assets/css/carrusel.css" />
	</head>

	<body class="is-preload">

		<!-- Header -->
		<section id="header">
			<header>
				<span class="image avatar"><img src="images/LOGO_LXVII_SLOGAN.png" alt="" /></span>
				<h1 id="logo"><a href="#">SECRETARÍA DE FISCALIZACIÓN</a></h1>
			</header>
			<nav id="nav">
				<ul id="dynamic-menu">
					 <!-- Los módulos se cargarán aquí dinámicamente -->
					<!-- <li><a href="#one" class="active">About</a></li>
					<li><a href="#two">Things I Can Do</a></li>
					<li><a href="#three">A Few Accomplishments</a></li>
					<li><a href="#four">Contact</a></li> -->
				</ul>
			</nav>
			<!-- <footer>
				<ul class="icons">
					<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
					<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="#" class="icon brands fa-github"><span class="label">Github</span></a></li>
					<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
				</ul>
			</footer> -->
		</section>

		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">

				<!-- One -->
				<section id="one">
					<div class="image main" data-position="center">
						<div class="owl-carousel owl-theme" id="banner-carousel" style="height: 400px;"></div>
							<!-- Las imágenes se cargarán dinámicamente desde la API -->
						</div>
					</div>
					<div class="container">
						<header class="major">
							<h2>Avisos</h2>
						</header>
						<div id="avisos-content">
							<!-- Los avisos se cargarán aquí dinámicamente -->
						</div>
					</div>
				</section>

				<!-- Two -->
				<!-- <section id="two">
					<div class="container">
						<h3>Things I Can Do</h3>
						<p>Integer eu ante ornare amet commetus vestibulum blandit integer in curae ac faucibus integer non. Adipiscing cubilia elementum integer lorem ipsum dolor sit amet.</p>
						<ul class="feature-icons">
							<li class="icon solid fa-code">Write all the code</li>
							<li class="icon solid fa-cubes">Stack small boxes</li>
							<li class="icon solid fa-book">Read books and stuff</li>
							<li class="icon solid fa-coffee">Drink much coffee</li>
							<li class="icon solid fa-bolt">Lightning bolt</li>
							<li class="icon solid fa-users">Shadow clone technique</li>
						</ul>
					</div>
				</section> -->
					
			</div>

			<!-- Footer -->
			<section id="footer">
				<div class="container">
					<ul class="copyright">
						<li>&copy; Congreso del Estado de Veracruz.</li><li>Ir a:<a href="http://legisver.gob.mx">LEGISVER</a></li>
					</ul>
				</div>
			</section>

		</div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

		<script>
			$(document).ready(function(){

				const rutaAvisos = 'http://legisver.gob.mx/sitioAdminFiscalizacion/public/storage/avisos/';
				const rutaNotas = 'http://legisver.gob.mx/sitioAdminFiscalizacion/public/storage/notas/';
				const rutaModulos = 'http://legisver.gob.mx/sitioAdminFiscalizacion/public/storage/modulos/';

				// Configuración para obtener datos de la API
				const settings = {
					async: true,
					crossDomain: true,
					url: 'http://127.0.0.1:8000/api/notas',
					method: 'GET'
				};

				// Realizar la petición AJAX
				$.ajax(settings).done(function(response) {
					mostrarCarrusel(response);
				}).fail(function(jqXHR, textStatus, errorThrown) {
					console.error("Error al cargar las imágenes:", textStatus, errorThrown);
					// Mostrar imagen por defecto si hay error
					$('#banner-carousel').html('<div class="item"><img src="images/banner.jpg" alt="Banner por defecto"></div>');
					inicializarCarrusel();
				});

				// Cargar menú de módulos
    			cargarModulos();

				// Cargar avisos
				cargarAvisos();

				// Función para mostrar el carrusel con los datos de la API
				function mostrarCarrusel(notas) {
					const carrusel = $('#banner-carousel');
					carrusel.empty(); // Limpiar contenido previo

					// Filtrar solo notas activas y agregar imágenes al carrusel
					notas.filter(nota => nota.activo == 1).forEach(nota => {
						const imagenes = nota.items || [];
						const rutaBase = 'http://127.0.0.1:8000/storage/notas/';
						
						imagenes.forEach(imagen => {
							const itemDiv = $('<div class="item"></div>');
							const imgElement = $('<img>').attr({
								'src': rutaBase + imagen.archivo,
								'alt': nota.nombre || 'Imagen del carrusel'
							});
							
							itemDiv.append(imgElement);
							carrusel.append(itemDiv);
						});
					});

					// Si no hay imágenes, mostrar una por defecto
					if (carrusel.children().length === 0) {
						carrusel.html('<div class="item"><img src="images/banner.jpg" alt="Banner por defecto"></div>');
					}

					// Inicializar el carrusel
					inicializarCarrusel();
				}

				// Función para inicializar Owl Carousel con animaciones
				function inicializarCarrusel() {
					$('#banner-carousel').owlCarousel({
						items: 1,
						loop: true,
						autoplay: true,
						autoplayTimeout: 5000,
						autoplayHoverPause: true,
						animateOut: 'fadeOut',
						animateIn: 'fadeIn',
						smartSpeed: 1000,
						nav: true,
						dots: true,
						navText: [
							'<i class="fa fa-angle-left"></i>',
							'<i class="fa fa-angle-right"></i>'
						]
					});
				}

				function cargarModulos() {
        			$.ajax({
            			url: 'http://127.0.0.1:8000/api/modulos',
            			method: 'GET',
            			dataType: 'json',
            			success: function(modulos) {
                			const $menu = $('#dynamic-menu');
                			$menu.empty();
                
                			// Obtener la ruta/hash actual
                			const currentPath = window.location.pathname + window.location.hash;
                			let moduloActivoEncontrado = false;
                
                			// Filtrar y ordenar módulos activos
                			const modulosActivos = modulos
                    		.filter(modulo => modulo.activo)
                    		.sort((a, b) => a.orden - b.orden);
                
                			// Si no hay módulos activos
                			if (modulosActivos.length === 0) {
                    			$menu.html('<li class="text-muted">No hay módulos disponibles</li>');
                    			return;
                			}
                
                			// Crear ítems del menú
                			modulosActivos.forEach(modulo => {
                    			const $li = $('<li></li>');
                    			const $a = $('<a></a>')
                        		.attr('href', modulo.enlace || '#')
                        		.text(modulo.nombre);
                    
                    			// Determinar si es el ítem activo
                    			const esActivo = currentPath.includes(modulo.enlace) || 
                                   (modulo.es_inicio && !moduloActivoEncontrado && currentPath.endsWith('/'));
                    
                    			if (esActivo) {
                        			$a.addClass('active');
                        			moduloActivoEncontrado = true;
                    			}
                    
                    			// Agregar icono si existe
                    			if (modulo.icono) {
	                        		$a.prepend(`<span class="icon ${modulo.icono}"></span> `);
    	                		}
							
                    			$li.append($a);
                    			$menu.append($li);
                			});
                
                			// Si ningún ítem quedó activo, activar el primero
                			if (!moduloActivoEncontrado && modulosActivos.length > 0) {
                    			$menu.find('li:first-child a').addClass('active');
                			}
                
	                		// Inicializar funcionalidad de scroll del template
    	            		if (typeof $.fn.scrolly === 'function') {
        	            		$menu.find('a').scrolly();
                			}
            			},
            			error: function(error) {
                			console.error('Error al cargar módulos:', error);
                			$('#dynamic-menu').html('<li class="text-danger">Error al cargar el menú</li>');
            			}
        			});
    			}

				// Función para cargar los avisos
				function cargarAvisos() {
					$.ajax({
						url: 'http://127.0.0.1:8000/api/avisos',
						method: 'GET',
						success: function(avisos) {
							const $avisosContent = $('#avisos-content');
							$avisosContent.empty();
							
							// Filtrar avisos activos y ordenar por fecha
							const avisosActivos = avisos
								.filter(aviso => aviso.activo)
								// .sort((a, b) => new Date(b.fecha_publicacion) - new Date(a.fecha_publicacion));
							
							if (avisosActivos.length === 0) {
								$avisosContent.html('<p class="text-muted">No hay avisos disponibles en este momento.</p>');
								return;
							}
							

							// Crear contenedor de avisos
							const $avisosContainer = $('<div class="avisos-container"></div>');
							
							
							// Agregar cada aviso
							avisosActivos.forEach(aviso => {
								const $avisoItem = $(`
									<div class="aviso-item">
										<p class="aviso-titulo">${aviso.nombre}</p>
									</div>
								`);

								$avisosContainer.append($avisoItem);


									const items = aviso.items || [];
									if (items.length > 0) {	
										const $archivosContainer = $('<div class="archivos-container"></div>');
										items.forEach(item => {
											const itemFile = `<a href="${item.archivo}" target="_blank">${item.descripcion}</a>`;
											
											$archivosContainer.append(`<div class="archivo-item">${itemFile}</div>`);

											$avisosContainer.append($archivosContainer);
										})
									}

							});
							
							$avisosContent.append($avisosContainer);
						},
						error: function(error) {
							console.error('Error avisos:', error);
							$('#avisos-content').html('<p class="text-danger">Error al cargar los avisos. Por favor intente más tarde.</p>');
						}
					});
				}

			});
		</script>
	</body>
</html>